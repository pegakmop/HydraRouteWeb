# HydraRoute

**Маршрутизация доменов на основе политик доступа** - выбрать куда перенаправить домены из `ipset` можно
просто изменив подключение в политике доступа веб-интерфейса роутера. 

## Установка:
1. Подключитесь к роутеру по SSH (к Entware).
2. Удалите старую версию **HydraRoute** :
    ```
    curl -Ls "https://raw.githubusercontent.com/Ground-Zerro/HydraRoute/refs/heads/main/uninstall.sh" | sh
    ```
3. После перезагрузки роутера:
    - установите **Beta** версию **HydraRoute**
    ```
    curl -L -s "https://raw.githubusercontent.com/pegakmop/HydraRoute/refs/heads/main/beta/hydra.sh" > /opt/tmp/hydra.sh && chmod +x /opt/tmp/hydra.sh && /opt/tmp/hydra.sh
    ```
3. После перезагрузки роутера:
    - в веб-панели роутера перейдите:
      * Приоритеты подключений -> Политики доступа в интернет
      * в политике **HydraRoute1st** включите нужный VPN или другое подключение

### Как добавить домены в ipset
1. Чтобы добавить домены для перенаправления, отредактируйте файл: `/opt/etc/AdGuardHome/ipset.conf`.
    ```
    nano /opt/etc/AdGuardHome/ipset.conf
    ```
   
   Пример `ipset.conf``:
   ```
   instagram.com,cdninstagram.com/hr1
   openai.com,chatgpt.com/hr2
   ```

   * В левой части через запятую указаны домены
   * В паровой после слэш - `ipset` политики, которой они управляются

       |  имя политики   |  ipset  |
       |:---------------:|:-------:|
       |  HydraRoute1st  |   hr1   |
       |  HydraRoute2nd  |   hr2   |
       |  HydraRoute3rd  |   hr3   |

2. После добавления доменов необходимо перезапустить **AdGuard Home** командой:
    ```
    /opt/etc/init.d/S99adguardhome restart
    ```
	Домены третьего уровня и выше включать в `ipset` не нужно, они подхватываются автоматически.
	* Пример: указав только `google.com` будут перенаправляться `mail.google.com`, `drive.google.com`, т.е. все домены, заканивающиеся на `google.com`.

## Информация:
- web-панели пока нет. Старая не подойдет.
- если указать не существующий ipset в `ipset.conf`: не будет запускаться AGH и работать DNS.
- приоритеты подключений работают! Можно установить порядок в котором будут последовательно переключаться туннели
если у вышестоящего пропадёт связь.
- если в политике снять все галочки с подключений - домены будут заблокированы.
- агрегация каналов *(многоуровневая передача)* не проверялась. Попробуйте, потом расскажите...
- изменения в политике применяются практически мгновенно, ничего перезагружать, включать или переподключать не нужно.
- в политику можно добавлять устройства. **Весь** их трафик в этом случае пойдет через указанное в политике подключение.
- WARP - работает.
- что будет если одновременно добавить в два или три `ipset` один и тотже домен? Ну проверьте, потом расскажите...

## ВАЖНО:
**Не пытайтесь переименовать или удалить политики**
- роутер самостоятельно перезагрузится, политики и их имена будут восстановлены.
